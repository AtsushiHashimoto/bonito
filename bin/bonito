cd `dirname $0`
. ../bonito.conf
. ../library/tools.sh
. ../library/subcommands.sh
. ../library/subcommands_kube.sh

function usage {
    cat <<EOF
$(basename ${0}) is a docker/kubertenes wrapper for research laboratory.

Usage:
    $(basename ${0}) [command] [<options>]

Command:
    create            create your docker container (and your kubertenes pod)
    run	              start/attach to your docker container (on kubertenes pod)
    shutdown          stop/kill your docker container (on kubertenes pod)
    reboot            shutdown, then, create

    create_master_node prepare a master node for bonito with kubertenes.
    create_slave_node make a node join to the master_node.
    info              show information about your container (and pod).

Basic Options:
    --version         print $(basename ${0}) version
    --help, -h        print this. With a command, print help for the command.
EOF
}

function version {
    echo "$(basename ${0}) version $BONITO_VERSION"
}

if [ $# -eq 0 ]; then
  usage
  exit 1
fi
subcommand=${1}
if [ `echo $subcommand | grep -- '--'`]; then
  subcommand=""
else
  shift
fi

# parse options
while [ $# -gt 0 ];
do
    case ${1} in
        --debug|-d)
            set -x
        ;;

        --verbose|-v)
	    is_verbose=1
        ;;

        --help|-h)
            show_help=1
        ;;

        --user|-u)
            user=${2}
            shift
        ;;

        --project|-p)
            project=${2}
            shift
        ;;

        --tag|-t)
            tag=${2}
            shift
        ;;

        --num_gpu|-g)
            num_gpu=${2}
            shift
        ;;

        --base_image|-b)
            base_image=${2}
            shift
        ;;

        --volume_size|-s)
            volume_size=${2}
            shift
        ;;

        --command|-c)
            command=${2}
            shift
        ;;

        *)
            echo "[ERROR] Invalid option '${1}'"
            show_help=1
        ;;
    esac
    shift
done

function my_silent_exec {
	echo $1 > /dev/null
}

# set default values if variables are not set by options.
my_silent_exec ${user:=$USER}
my_silent_exec ${project:=$BONITO_DEFAULT_PROJ}
my_silent_exec ${tag:=latest}
my_silent_exec ${num_gpu:=1}
my_silent_exec ${command:="/bin/sh"}
image=$(bonito_image)
pod_name=$(bonito_pod_name)
if [ $(has_base_project) -eq 1 ]; then
  my_silent_exec ${base_image:=$(bonito_image_custom default $project)}
else
  my_silent_exec ${base_image:=$(bonito_image_custom default default)}
fi
my_silent_exec ${volume_size:=$BONITO_PV_HOME_SIZE}

if [ "x$is_verbose" = "x1" ]; then
  echo user: $user
  echo project: $project
fi

# the list of subcommands
subcommands=(create run shutdown reboot create_master_node create_slave_node info)

containsElement () {
  local e match="$1"
  shift
  for e; do [[ "$e" == "$match" ]] && return 0; done
  return 1
}

# execute main functions
if $(containsElement $subcommand ${subcommands[@]}); then
  if [ "x$show_help" = "x1" ]; then
    # ex.) help_bonito_run in ../library/subcommands*.sh
    help_bonito_$subcommand
  else
    # ex.) bonito_run in ../library/subcommands*.sh
    bonito_$subcommand
  fi
else
  case $subcommand in
    help|--help|-h )
        usage
    ;;

    version|--version )
        version
    ;;

    *)
        echo "[ERROR] Invalid subcommand '${1}'"
        usage
        exit 1
    ;;
  esac
fi
